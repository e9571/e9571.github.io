<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>account</title>
</head>



  <!--不显示下划线代码-->
  <style type ="text/css">
a{text-decoration:none}                      /*页面载入的链接样式为无下划线*/
a:hover{text-decoration:underline}       /*鼠标移动到链接时为下划线*/

body,td,th {
	font-size: 16px;
	font-weight: bold;
	color: #00F;
	font-family: "微软雅黑";
}
  </style>
  
<script src="./js/web3.min.js"></script>
<script src="./js/jquery_v3.5.1.min.js"></script>
<!--支持中文应用-->
<script src="./js/utf8_tools.js"></script>
<script src="./js/jquery.base64.chinese.js"></script>


<script type="text/javascript">		

//NFT 铸造与销售函数
//http://127.0.0.1/nft_market_min/nft_batch.html

//全局信息配置
$(document).ready(function(){
	
	//http://127.0.0.1/nft_market_min/fulfillRandomWords.html

    //随机数消费合约地址 需要在后台注册
	$("#contract").val("0x30f52C5Ba62A8d0403Db910AFF43d876391EaC70");
	
	//设置全局链接
	$("#web3connect").val("https://goerli.infura.io/v3/beb58a744d6a47ecb3176bc2bef2f0ff");
   
   console.log('web3链接地址',$("#web3connect").val());//打印服务器信息
   console.log('合约地址',$("#contract").val());//打印服务器信息
			
});



//查询用户基础信息
function account(){
	
	var web3Provider;

    if (window.ethereum) {
        web3Provider = window.ethereum;
        try {
            // 请求用户授权
             window.ethereum.enable();
        } catch (error) {
            // 用户不授权时
            console.error("User denied account access")
        }
    }
	//链接数据实例 使用币安测试网节点
    //web3js = new Web3(web3Provider|| "https://data-seed-prebsc-1-s1.binance.org:8545/");
	web3js = new Web3(web3Provider|| $("#web3connect").val());
	
    web3js.eth.getAccounts(function (error, result) {
        if (!error)
            console.log(result);//打印账号信息
			//console.log($("#address").text(result[0]));
			$("#address").val(result[0]);	
			$("#address").text($("#address").val());
			
			//显示账户余额信息 显示链上查询到的余额信息 未进行数值转换，默认小数点后18位		
            web3js.eth.getBalance($("#address").val()).then(account_balance);
    });
	
}


function create(){
	
	//申请链接句柄
	var web3Provider;

    if (window.ethereum) {
        web3Provider = window.ethereum;
        try {
            // 请求用户授权
             window.ethereum.enable();
        } catch (error) {
            // 用户不授权时
            console.error("User denied account access")
        }
    }
	//链接数据实例 
    //web3js = new Web3(web3Provider|| "https://data-seed-prebsc-1-s1.binance.org:8545/");
	web3js = new Web3(web3Provider|| "wss://rinkeby.infura.io/ws/v3/509b5f37c12440b7befb229b2613369c");
	
    web3js.eth.getAccounts(function (error, result) {
        if (!error)
            console.log(result);//打印账号信息
			$("#address").val(result[0]);			
    });
	
	
    //初始化合约
	address=$("#contract").val();
	abi_text=contract_abi();
	MyContract = new web3js.eth.Contract(JSON.parse(abi_text), address);

	//预估 Gas 费用 
	//请求随机数
    MyContract.methods.requestRandomWords().estimateGas({from: $("#address").val()}).then(account_debug);  //接收 Gas 费用
    
    MyContract.methods.requestRandomWords().send({from: $("#address").val(),gas: 10001000  //Gas 调到最大，以免在铸造过程中出现终中断的情况
    }, function(error, transactionHash){
       if (!error) {
	   console.log("交易hash：", transactionHash)
       } else {
	   console.log(error)
       }
    }).then(function (receipt) {//监听后续的交易情况
	
       console.log('交易响应',receipt);
       console.log("交易状态：", receipt.status);
	   console.log("交易事件消息：", receipt.events);	  
    });

}

//获得指定范围随机数
function GetRandom(){
	
	//申请链接句柄
	var web3Provider;

    if (window.ethereum) {
        web3Provider = window.ethereum;
        try {
            // 请求用户授权
             window.ethereum.enable();
        } catch (error) {
            // 用户不授权时
            console.error("User denied account access")
        }
    }
	//链接数据实例 
    //web3js = new Web3(web3Provider|| "https://data-seed-prebsc-1-s1.binance.org:8545/");
	web3js = new Web3(web3Provider|| "wss://rinkeby.infura.io/ws/v3/509b5f37c12440b7befb229b2613369c");
	
    web3js.eth.getAccounts(function (error, result) {
        if (!error)
            console.log(result);//打印账号信息
			$("#address").val(result[0]);			
    });
	
	
    //初始化合约
	address=$("#contract").val();
	abi_text=contract_abi();
	MyContract = new web3js.eth.Contract(JSON.parse(abi_text), address);

   	MyContract.methods.GetRandom($("#start").val(),$("#end").val()).call().then(account_debug);

}

//账户余额回调设置
function account_balance(result){
	  console.log(result);
	  $("#balance").text(result);
}

//账户代币余额
function account_debug(result){
	  console.log('debug',result);
}

//合约地址
function contract_abi(){
	
	var text='[{"inputs":[{"internalType":"uint64","name":"subscriptionId","type":"uint64"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"have","type":"address"},{"internalType":"address","name":"want","type":"address"}],"name":"OnlyCoordinatorCanFulfill","type":"error"},{"inputs":[{"internalType":"uint256","name":"start","type":"uint256"},{"internalType":"uint256","name":"end","type":"uint256"}],"name":"GetRandom","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"requestId","type":"uint256"},{"internalType":"uint256[]","name":"randomWords","type":"uint256[]"}],"name":"rawFulfillRandomWords","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"requestRandomWords","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"s_randomWords","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"s_requestId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}]';
	
	return text;	
}
	
</script>

<body>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<table width="1064" border="0" align="center">
  <tr>
    <td width="58">&nbsp;</td>
    <td width="194">&nbsp;</td>
    <td width="271">&nbsp;</td>
    <td width="147">&nbsp;</td>
    <td width="372">&nbsp;</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>账户地址：</td>
    <td>
      <p id="address" align="left" ></p></td>
    <td><input type="submit" name="account" id="account" value="链接账户" style="width:100px;height:30px"  onclick="account()"/></td>
    <td>
     <input type="hidden" name="contract" id="contract" />
     <input type="hidden" name="web3connect" id="web3connect" />
     （请先链接账户）</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>账户ETH余额：</td>
    <td><p id="balance" align="left" ></p></td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
</table>
<p>&nbsp;</p>




</body>
</html>
